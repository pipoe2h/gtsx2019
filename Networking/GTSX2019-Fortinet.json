{"status":{},"spec":{"description":"","resources":{"client_attrs":{"85789db9_deployment_cloned_0":{"y":-74,"x":423},"None":{"y":-11,"x":442},"8070efb4_deployment":{"y":-27,"x":693}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"LocalService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"435bde07_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"6c7a65b4_runbook","main_task_local_reference":{"kind":"app_task","name":"435bde07_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"LocalService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"840a6b38_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"7e67cdeb_runbook","main_task_local_reference":{"kind":"app_task","name":"840a6b38_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"LocalService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"40a1dc9a_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"0e7aa4a1_runbook","main_task_local_reference":{"kind":"app_task","name":"40a1dc9a_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"LocalService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6a783908_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"0d086fa7_runbook","main_task_local_reference":{"kind":"app_task","name":"6a783908_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"LocalService"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a4d46de6_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"16505453_runbook","main_task_local_reference":{"kind":"app_task","name":"a4d46de6_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"LocalService","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","description":"","name":"forti_name","type":"LOCAL","value":"fortifw","label":"","attrs":{"type":""}}],"description":""},{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"FortiGate"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"8c0b7aac_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"e336f5a5_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"8c0b7aac_dag_cloned_1"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"FortiGate"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"9c114dea_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"bc52929d_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"9c114dea_dag_cloned_1"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"FortiGate"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6aaef5c4_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"6664cdf0_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"6aaef5c4_dag_cloned_1"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"FortiGate"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"44b9e532_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"850d536e_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"44b9e532_dag_cloned_1"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"FortiGate"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"3bbf6d30_dag_cloned_1","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"3b4902aa_runbook_cloned_0","main_task_local_reference":{"kind":"app_task","name":"3bbf6d30_dag_cloned_1"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"FortiGate","port_list":[],"tier":"","variable_list":[],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"EXISTING_VM","name":"LOCAL","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":true,"address":"@@{ip_address}@@","delay_secs":"60","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"admin"}},"os_type":"Linux","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"1.1.1.1"},"variable_list":[]},{"description":"","action_list":[],"type":"AHV_VM","name":"FortiGateVM","readiness_probe":{"connection_type":"SSH","retries":"5","disable_readiness_probe":true,"address":"@@{platform.status.resources.nic_list[0].ip_endpoint_list[0].ip}@@","delay_secs":"600","connection_port":22,"login_credential_local_reference":{"kind":"app_credential","name":"admin"}},"editables":{"create_spec":{"name":true,"resources":{"nic_list":{},"serial_port_list":{},"num_vcpus_per_socket":true,"num_sockets":true,"memory_size_mib":true,"guest_customization":true,"disk_list":{}}}},"os_type":"Linux","create_spec":{"name":"@@{LocalService.forti_name}@@-@@{calm_unique}@@","resources":{"nic_list":[{"nic_type":"NORMAL_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":{"kind":"subnet","type":"","name":"","uuid":"1b23ce11-8fa3-4c72-b96a-c00da6ada80b"},"type":""},{"nic_type":"NETWORK_FUNCTION_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"INGRESS","mac_address":"","subnet_reference":null,"type":""},{"nic_type":"NETWORK_FUNCTION_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"EGRESS","mac_address":"","subnet_reference":null,"type":""},{"nic_type":"NETWORK_FUNCTION_NIC","ip_endpoint_list":[],"network_function_chain_reference":null,"network_function_nic_type":"TAP","mac_address":"","subnet_reference":null,"type":""}],"serial_port_list":[],"guest_tools":null,"num_vcpus_per_socket":1,"num_sockets":1,"gpu_list":[],"memory_size_mib":1024,"parent_reference":null,"hardware_clock_timezone":"","guest_customization":{"cloud_init":{"meta_data":"","type":"","user_data":"config system global \n\tset hostname @@{HOSTNAME}@@\nend \n \nconfig system interface \n\tedit port1 \n\t\tset mode dhcp \n\t\tset allowaccess https ssh ping fgfm http\n\t\tset type physical \n\t\tset snmp-index 1 \n\tnext \nend\n\nconfig system virtual-wire-pair \n\tedit fortigate  \n\t\tset member port2 port3 \n\t\tset wildcard-vlan enable \n\t\tset vlan-filter 3132-3132 \n\tnext \nend\n\nconfig system ntp\n\t\tset ntpsync enable\nend\nconfig system ntp\n\t\tset type custom\n        config ntpserver\n        \tedit 1\n            \tset server @@{NTP_SERVER}@@\n\tnext\nend\nconfig system ntp\n\t\tset type custom\n\nend"},"type":"","sysprep":null},"power_state":"ON","type":"","boot_config":{"boot_device":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"}},"type":"","mac_address":""},"disk_list":[{"data_source_reference":{"kind":"image","type":"","name":"fortios.qcow2","uuid":"af4ec63a-774b-4aed-ae99-91f3f2795767"},"type":"","disk_size_mib":0,"volume_group_reference":null,"device_properties":{"type":"","disk_address":{"type":"","device_index":0,"adapter_type":"SCSI"},"device_type":"DISK"}}]},"availability_zone_reference":null,"backup_policy":null,"type":"","cluster_reference":null,"categories":{"network_function_provider":"FortiGate"}},"variable_list":[]}],"credential_definition_list":[{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"admin"},{"username":"sys","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"sys"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"LocalService"}],"name":"CreateCategoriesAndNF","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"CreateCategoriesAndNF"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[{"kind":"app_task","name":"CreateNF"},{"kind":"app_task","name":"SetVar"}],"name":"f216d285_dag","state":"ACTIVE","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"CreateNF"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"SetVar"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"LocalService"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"CreateNF","state":"ACTIVE","attrs":{"script":"prism_ip = \"@@{PC_IP}@@\"\ncluster_name = \"@@{CLUSTER_NAME}@@\"\nnf_chain_name = \"@@{NF_CHAIN_NAME}@@\"\n\n\ndef crudops(api_url, payload):\n  jwt = '@@{calm_jwt}@@'\n  headers = {'Content-Type': 'application\/json',  'Accept':'application\/json', 'Authorization': 'Bearer {}'.format(jwt)}\n  r = urlreq(api_url, verb='POST', params=json.dumps(payload), headers=headers, verify=False)\n  if r.ok:\n    resp = json.loads(r.content)\n    return resp\n  else:\n    print \"Post request failed\", r.content\n    exit(1)\n\ndef setconfig(api_url, payload):\n  jwt = '@@{calm_jwt}@@'\n  headers = {'Content-Type': 'application\/json',  'Accept':'application\/json', 'Authorization': 'Bearer {}'.format(jwt)}\n  r = urlreq(api_url, verb='PUT', params=json.dumps(payload), headers=headers, verify=False)\n  if r.ok:\n    resp = json.loads(r.content)\n    return resp\n  else:\n    print \"PUT request failed\", r.content\n    exit(1)\n    \nprint \"Creating network function provider category\"\n\ncategory_api = 'https:\/\/{0}:9440\/api\/nutanix\/v3\/categories\/network_function_provider'.format(prism_ip)\npayload = {\n\"name\": \"network_function_provider\"\n}\nsetconfig(api_url=category_api, payload=payload)\n\nprint \"Assigning value to network function provider category\"\npan_api = 'https:\/\/{0}:9440\/api\/nutanix\/v3\/categories\/network_function_provider\/FortiGate'.format(prism_ip)\npayload = {\n\"value\": \"FortiGate\"\n}\nsetconfig(api_url=pan_api, payload=payload)\n\nprint \"Category list\"\ncat_list_api = 'https:\/\/{0}:9440\/api\/nutanix\/v3\/categories\/network_function_provider\/list'.format(prism_ip)\npayload = {\"kind\": \"category\"}\nprint crudops(api_url=cat_list_api, payload=payload)\n\n\nprint \"Get cluster list\"\ncluster_api = 'https:\/\/{0}:9440\/api\/nutanix\/v3\/clusters\/list'.format(prism_ip)\npayload = {\"kind\": \"cluster\"}\ncluster_list = crudops(api_url=cluster_api, payload=payload)\nfor i in cluster_list['entities']:\n  if i['spec']['name'] == cluster_name:\n    print i\n    cluster_uuid = i['metadata']['uuid']\n\nprint cluster_uuid\nprint cluster_name\n    \nprint \"Get NF list\"\nnf_list_api = 'https:\/\/{0}:9440\/api\/nutanix\/v3\/network_function_chains\/list'.format(prism_ip)\npayload = {}\nnf_list = crudops(api_url=nf_list_api, payload=payload)\nnf_exists = False\nfor i in nf_list['entities']:\n  if i['status']['name'] == nf_chain_name:\n    print i\n    nf_exists = True\n    nf_uuid = i['metadata']['uuid']\n    \nprint \"Creating\/Updating service chain\"\nservice_chain_api = 'https:\/\/{0}:9440\/api\/nutanix\/v3\/network_function_chains'.format(prism_ip)\npayload = {\n\"spec\": {\n\"name\": nf_chain_name,\n\"resources\": {\n\"network_function_list\": [\n{\n\"network_function_type\": \"INLINE\",\n\"category_filter\": {\n\"type\": \"CATEGORIES_MATCH_ANY\",\n\"params\": {\"network_function_provider\": [\"FortiGate\"]}\n}\n}\n]\n},\n\"cluster_reference\": {\n\"kind\": \"cluster\",\n\"name\": cluster_name,\n\"uuid\": cluster_uuid\n}\n},\n\"api_version\": \"3.1.0\",\n\"metadata\": {\n\"kind\": \"network_function_chain\"\n}\n}\n\nif nf_exists:\n  print \"Not creating chain as chain exists\"\n  #service_chain_api = service_chain_api + '\/' + nf_uuid\n  #setconfig(api_url=service_chain_api, payload=payload)\nelse:\n  crudops(api_url=service_chain_api, payload=payload)\n  print \"Created service chain\"\n\n","type":"","command_line_args":"","exit_status":[],"script_type":"static"},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"LocalService"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"SetVar","state":"ACTIVE","attrs":{"exit_status":[],"script":"print \"forti_name=FortiGate\"","eval_variables":["forti_name"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]}],"description":"","name":"d60e886c_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"f216d285_dag"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"CreateCategoriesAndNF"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"2fce3856_dag","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"4b2171be_runbook","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"2fce3856_dag"},"message_list":[],"variable_list":[]}},"variable_list":[]},{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"FortiGate"}],"name":"Configuration","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Configuration"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"3a805182_dag_cloned_1","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"18da9439_runbook_cloned_0","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"3a805182_dag_cloned_1"},"message_list":[],"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Configuration"},"retries":"0","description":"","message_list":[],"child_tasks_local_reference_list":[],"name":"8d843173_dag_cloned_1","state":"ACTIVE","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"1d6d9396_runbook_cloned_0","state":"ACTIVE","main_task_local_reference":{"kind":"app_task","name":"8d843173_dag_cloned_1"},"message_list":[],"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"8070efb4_deployment","published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"CreateCategoriesAndNF"}],"substrate_local_reference":{"kind":"app_substrate","name":"LOCAL"},"min_replicas":"1","variable_list":[],"description":""},{"type":"GREENFIELD","action_list":[],"depends_on_list":[],"name":"85789db9_deployment_cloned_0","published_service_local_reference_list":[],"max_replicas":"99","package_local_reference_list":[{"kind":"app_package","name":"Configuration"}],"substrate_local_reference":{"kind":"app_substrate","name":"FortiGateVM"},"min_replicas":"@@{COUNT}@@","variable_list":[],"description":""}],"description":"","action_list":[{"description":"This action is used to scale out the no of fortigate vms on the cluster","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"ScaleOut"}],"name":"47593285_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"85789db9_deployment_cloned_0"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"ScaleOut","attrs":{"scaling_count":"@@{SCALEOUT_COUNT}@@","type":"","scaling_type":"SCALEOUT"},"timeout_secs":"0","type":"SCALING","variable_list":[]}],"description":"","name":"e47f3869_runbook","main_task_local_reference":{"kind":"app_task","name":"47593285_dag"},"variable_list":[{"val_type":"STRING","description":"","name":"SCALEOUT_COUNT","type":"LOCAL","value":"1","label":"","attrs":{"type":""},"editables":{"value":true}}]},"name":"ScaleOut"},{"description":"This action is used to scale in the no of fortigate vms on the cluster","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"ScaleIn"}],"name":"6e05e2e2_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_blueprint_deployment","name":"85789db9_deployment_cloned_0"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"ScaleIn","attrs":{"scaling_count":"@@{SCALEIN_COUNT}@@","type":"","scaling_type":"SCALEIN"},"timeout_secs":"0","type":"SCALING","variable_list":[]}],"description":"","name":"aa73d797_runbook","main_task_local_reference":{"kind":"app_task","name":"6e05e2e2_dag"},"variable_list":[{"val_type":"STRING","description":"","name":"SCALEIN_COUNT","type":"LOCAL","value":"1","label":"","attrs":{"type":""},"editables":{"value":true}}]},"name":"ScaleIn"},{"description":"","type":"user","critical":false,"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"a6398978_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"c2f33ced_runbook","main_task_local_reference":{"kind":"app_task","name":"a6398978_dag"},"variable_list":[]},"name":"Add New Category"}],"name":"AHV","variable_list":[{"val_type":"STRING","description":"","name":"PC_IP","type":"LOCAL","value":"10.42.104.39","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"CLUSTER_NAME","type":"LOCAL","value":"PHX-POC104","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"NF_CHAIN_NAME","type":"LOCAL","value":"FortinetFW","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"COUNT","type":"LOCAL","value":"4","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"NTP_SERVER","type":"LOCAL","value":"","label":"","attrs":{"type":""},"editables":{"value":true}},{"val_type":"STRING","description":"","name":"HOSTNAME","type":"LOCAL","value":"","label":"","attrs":{"type":""},"editables":{"value":true}}]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"admin"},"type":"USER"},"name":"GTSX2019-Fortinet"},"api_version":"3.0","metadata":{"last_update_time":"1553711571908590","kind":"blueprint","spec_version":30,"creation_time":"1553613259607545","name":"GTSX2019-Fortinet"}}